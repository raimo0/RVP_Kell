<!DOCTYPE html>
<meta charset="utf-8" />

<script language="javascript" type="text/javascript">

var url = 'ws://' + window.location.hostname + '/ws';

function init() {
    document.getElementById('color1').addEventListener('input', color1_changed);
    document.getElementById('color2').addEventListener('input', color2_changed);
    document.getElementById('color3').addEventListener('input', color3_changed);
    document.getElementById('selected_color').addEventListener('input', selected_color_changed);
    document.getElementById('brightness').addEventListener('input', brightness_changed);

    function color1_changed() {
      console.log("color"+document.getElementById('color1').value);
      doSend("color1"+document.getElementById('color1').value);
    }
    function color2_changed() {
      console.log("color"+document.getElementById('color2').value);
      doSend("color2"+document.getElementById('color2').value);
    }
    function color3_changed() {
      console.log("color"+document.getElementById('color3').value);
      doSend("color3"+document.getElementById('color3').value);
    }
    function selected_color_changed() {
      console.log("selectedcolor#"+document.getElementById('selected_color').value);
      doSend("selectedcolor#"+document.getElementById('selected_color').value);
    }
    function brightness_changed() {
      console.log("brightness#"+document.getElementById('brightness').value);
      doSend("brightness#"+document.getElementById('brightness').value);
    }
    wsConnect();
}

function wsConnect() {
    websocket = new WebSocket(url);
    websocket.onopen = function(evt) { onOpen(evt) };
    websocket.onclose = function(evt) { onClose(evt) };
    websocket.onmessage = function(evt) { onMessage(evt) };
    websocket.onerror = function(evt) { onError(evt) };
  websocket.addEventListener("message", onMessage)
}

function onOpen(evt) {
    console.log("Connected");
}

function onClose(evt) {
    console.log("Disconnected");
    setTimeout(function() { wsConnect(url) }, 2000);
}

function onMessage(evt) {
  var messagePieces = evt.data.split(":");
  if(evt.data.startsWith("color")) {
      console.log("Received: " + evt.data);
      updateColor(messagePieces[0], messagePieces[1]);
  }
  else if (evt.data.startsWith("selectedcolor")) {
    document.getElementById('selected_color').value = messagePieces[1];
  }
  else if (evt.data.startsWith("brightness")) {
    document.getElementById('brightness').value = messagePieces[1];
  }
}

function updateColor(elementId, colorValue) {
    var colorInput = document.getElementById(elementId);
    if (colorInput) {
        if (colorInput.value !== colorValue) {
            colorInput.value = colorValue;
            colorInput.dispatchEvent(new Event('input'));
        }
    }
}

function onError(evt) {
    console.log("ERROR: " + evt.data);
}

function doSend(message) {
    console.log("Sending: " + message);
    websocket.send(message);
}

window.addEventListener("load", init, false);
</script>

<head>
  <title>RVP Kell</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
  <h2>RVP Kell</h2>
  <table>
    <tr>
      <div>
        <label for="selected_color">Selected color preset (1-3):</label>
        <input type="number" id="selected_color" name="selected_color" min="1" max="3" value="1" />
      </div>
    </tr>
    <tr>
      <div>
        <label for="brightness">Backlight brightness (0-255):</label>
        <input type="number" id="brightness" name="brightness" min="0" max="255" value="100" />
      </div>
    </tr>
    <tr>
      <div>
        <label for="color1">1. Preset</label>
        <input type="color" id="color1" name="color1" />
      </div>
    </tr>
    <tr>
      <div>
        <label for="color2">2. Preset</label>
        <input type="color" id="color2" name="color2" />
      </div>
    </tr>
    <tr>
      <div>
        <label for="color3">3. Preset</label>
        <input type="color" id="color3" name="color3" />
      </div>
    </tr>
  </table>
</body>